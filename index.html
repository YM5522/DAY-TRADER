<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#050a0e">
<title>TradeSimulator</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Noto+Sans+JP:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #000000;
    --card: #0f2030;
    --border: #1a3a52;
    --accent: #00d4ff;
    --green: #ff3355;
    --red: #00e87a;
    --yellow: #ffd700;
    --text: #d0e8f5;
    --dim: #4a6a80;
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
  }
  * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  html { height:100%; background:#000000; }
  body {
    height:100%; display:flex; flex-direction:column;
    overflow:hidden; overscroll-behavior:none;
    background:var(--bg); color:var(--text);
    font-family:'Noto Sans JP',sans-serif; font-size:14px;
    -webkit-font-smoothing:antialiased;
  }
  .up { color:var(--green); } .down { color:var(--red); }

  /* HEADER */
  .app-header { flex-shrink:0; padding-top:var(--safe-top); background:rgba(5,10,14,0.98); border-bottom:1px solid var(--border); }
  .header-inner { display:flex; align-items:center; justify-content:space-between; padding:10px 16px; height:52px; }
  .logo { font-family:'Share Tech Mono',monospace; font-size:16px; color:var(--accent); letter-spacing:2px; }
  .header-balance { font-family:'Share Tech Mono',monospace; font-size:17px; font-weight:bold; }
  .header-change { font-family:'Share Tech Mono',monospace; font-size:11px; margin-top:1px; text-align:right; }

  /* TAB BAR */
  .tab-bar { flex-shrink:0; display:flex; background:#080f18; border-bottom:1px solid var(--border); }
  .tab-item { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; height:50px; gap:3px; color:var(--dim); font-size:10px; user-select:none; border-bottom:2px solid transparent; margin-bottom:-1px; transition:color 0.15s; }
  .tab-item.active { color:var(--accent); border-bottom-color:var(--accent); }
  .tab-item:active { background:rgba(0,212,255,0.07); }
  .tab-icon { font-size:17px; line-height:1; }

  /* SCROLL PAGES */
  .scroll-container { flex:1; overflow-y:auto; overflow-x:hidden; -webkit-overflow-scrolling:touch; overscroll-behavior-y:contain; display:none; padding-bottom:var(--safe-bottom); background:#000000; min-height:0; }
  .scroll-container.active { display:flex; flex-direction:column; }
  .page { padding:12px 14px 20px; background:#000000; }

  /* CHART CONTAINER */
  .chart-container { flex:1; display:none; flex-direction:column; overflow:hidden; padding:8px 10px; padding-bottom:calc(8px + var(--safe-bottom)); gap:6px; min-height:0; background:#000000; }
  .chart-container.active { display:flex; }

  /* STAT GRID */
  .stat-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:12px; }
  .stat-card { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px 14px; }
  .stat-card-label { font-size:10px; color:var(--dim); letter-spacing:1px; text-transform:uppercase; margin-bottom:4px; }
  .stat-card-value { font-family:'Share Tech Mono',monospace; font-size:16px; font-weight:bold; }

  /* CARD */
  .card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:14px; margin-bottom:12px; }
  .card-title { font-size:10px; letter-spacing:2px; text-transform:uppercase; color:var(--dim); margin-bottom:10px; }

  /* STOCK LIST */
  .stock-row { display:flex; align-items:center; justify-content:space-between; padding:12px 0; border-bottom:1px solid rgba(26,58,82,0.5); cursor:pointer; }
  .stock-row:last-child { border-bottom:none; }
  .stock-row:active { opacity:0.7; }
  .stock-left { display:flex; align-items:center; gap:11px; }
  .stock-badge { width:42px; height:42px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-family:'Share Tech Mono',monospace; font-size:11px; font-weight:bold; flex-shrink:0; }
  .up-badge { background:rgba(255,51,85,0.1); color:var(--green); border:1px solid rgba(255,51,85,0.2); }
  .down-badge { background:rgba(0,232,122,0.1); color:var(--red); border:1px solid rgba(0,232,122,0.2); }
  .stock-info .sym { font-family:'Share Tech Mono',monospace; font-size:15px; font-weight:bold; }
  .stock-info .nm { font-size:11px; color:var(--dim); margin-top:2px; }
  .stock-right { text-align:right; }
  .stock-right .pr { font-family:'Share Tech Mono',monospace; font-size:15px; }
  .stock-right .pch { font-size:11px; margin-top:2px; }

  /* TICKER */
  .ticker-wrap { overflow:hidden; white-space:nowrap; padding:7px 0; border-bottom:1px solid var(--border); margin-bottom:12px; }
  .ticker-inner { display:inline-flex; gap:24px; animation:tickerScroll 20s linear infinite; }
  @keyframes tickerScroll { from{transform:translateX(0)} to{transform:translateX(-50%)} }
  .ticker-item { font-family:'Share Tech Mono',monospace; font-size:11px; white-space:nowrap; }

  /* CHIPS */
  .chip-row { display:flex; gap:5px; flex-wrap:wrap; }
  .chip { flex-shrink:0; padding:5px 11px; border:1px solid var(--border); border-radius:20px; font-family:'Share Tech Mono',monospace; font-size:11px; color:var(--dim); cursor:pointer; white-space:nowrap; }
  .chip.active { border-color:var(--accent); color:var(--accent); background:rgba(0,212,255,0.1); }

  /* TF BUTTONS */
  .tf-btn { padding:4px 9px; border:1px solid var(--border); background:transparent; color:var(--dim); font-family:'Share Tech Mono',monospace; font-size:11px; cursor:pointer; border-radius:7px; }
  .tf-btn.active { border-color:var(--accent); color:var(--accent); background:rgba(0,212,255,0.1); }

  /* CHANGE BADGE */
  .change-badge { font-family:'Share Tech Mono',monospace; font-size:11px; padding:2px 7px; border-radius:20px; }
  .change-up { background:rgba(255,51,85,0.15); color:var(--green); }
  .change-down { background:rgba(0,232,122,0.15); color:var(--red); }

  /* TRADE PAGE */
  .current-price-row { display:flex; justify-content:space-between; align-items:center; padding:11px 14px; background:rgba(255,255,255,0.05); border-radius:12px; margin-bottom:12px; }
  .cp-label { font-size:12px; color:var(--dim); }
  .cp-value { font-family:'Share Tech Mono',monospace; font-size:20px; font-weight:bold; }
  .position-card { background:#111111; border:1px solid var(--border); border-radius:16px; padding:14px; margin-bottom:12px; }
  .pos-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  .pos-item .label { font-size:10px; color:var(--dim); text-transform:uppercase; letter-spacing:1px; margin-bottom:3px; }
  .pos-item .value { font-family:'Share Tech Mono',monospace; font-size:15px; }
  .qty-input { background:rgba(0,0,0,0.4); border:1px solid var(--border); color:var(--text); font-family:'Share Tech Mono',monospace; font-size:22px; padding:12px 14px; border-radius:12px; width:100%; outline:none; -webkit-appearance:none; text-align:center; margin-bottom:8px; }
  .qty-input:focus { border-color:var(--accent); }
  .qty-presets { display:grid; grid-template-columns:repeat(4,1fr); gap:6px; margin-bottom:12px; }
  .qty-preset { padding:14px 0; background:rgba(0,0,0,0.3); border:1px solid var(--border); color:var(--dim); font-family:'Share Tech Mono',monospace; font-size:15px; cursor:pointer; border-radius:10px; text-align:center; }
  .qty-preset:active { background:rgba(0,212,255,0.15); border-color:var(--accent); color:var(--accent); }
  .order-details { background:rgba(0,0,0,0.2); border-radius:12px; padding:11px; margin-bottom:14px; font-size:12px; }
  .ord-row { display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px solid rgba(26,58,82,0.3); }
  .ord-row:last-child { border-bottom:none; }
  .ord-label { color:var(--dim); }
  .ord-value { font-family:'Share Tech Mono',monospace; }
  .trade-btns { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  .btn-buy,.btn-sell { padding:16px; border:none; font-family:'Share Tech Mono',monospace; font-size:15px; letter-spacing:2px; cursor:pointer; border-radius:12px; font-weight:bold; display:flex; flex-direction:column; align-items:center; gap:2px; }
  .btn-buy { background:rgba(255,51,85,0.15); color:var(--green); border:1.5px solid var(--green); }
  .btn-buy:active { background:rgba(255,51,85,0.3); transform:scale(0.97); }
  .btn-sell { background:rgba(0,232,122,0.15); color:var(--red); border:1.5px solid var(--red); }
  .btn-sell:active { background:rgba(0,232,122,0.3); transform:scale(0.97); }
  .btn-sub { font-size:10px; opacity:0.6; letter-spacing:1px; font-weight:normal; }

  /* CONTROLS */
  .ctrl-btn { padding:6px 12px; border-radius:9px; font-family:'Share Tech Mono',monospace; font-size:11px; cursor:pointer; border:1px solid; }
  .ctrl-pause { background:rgba(0,212,255,0.1); border-color:var(--accent); color:var(--accent); }
  .ctrl-reset { background:rgba(255,215,0,0.1); border-color:var(--yellow); color:var(--yellow); }
  .speed-wrap { flex:1; display:flex; align-items:center; gap:8px; background:var(--card); border:1px solid var(--border); border-radius:9px; padding:6px 11px; }
  .speed-label { font-size:10px; color:var(--dim); white-space:nowrap; }
  .speed-slider { -webkit-appearance:none; flex:1; height:3px; background:var(--border); outline:none; border-radius:2px; }
  .speed-slider::-webkit-slider-thumb { -webkit-appearance:none; width:18px; height:18px; border-radius:50%; background:var(--accent); cursor:pointer; }

  /* LOG */
  .log-entry { padding:11px; border-radius:11px; margin-bottom:7px; display:flex; justify-content:space-between; align-items:center; animation:slideIn 0.2s ease; }
  @keyframes slideIn { from{opacity:0;transform:translateY(-5px)} to{opacity:1;transform:translateY(0)} }
  .log-buy { background:rgba(255,51,85,0.08); border-left:3px solid var(--green); }
  .log-sell { background:rgba(0,232,122,0.08); border-left:3px solid var(--red); }
  .log-type { font-family:'Share Tech Mono',monospace; font-size:13px; font-weight:bold; }
  .log-detail { font-size:11px; color:var(--dim); margin-top:2px; }
  .log-price { font-family:'Share Tech Mono',monospace; font-size:13px; text-align:right; }
  .log-pnl { font-family:'Share Tech Mono',monospace; font-size:11px; padding:1px 6px; border-radius:10px; display:inline-block; margin-top:3px; }
  .pnl-pos { background:rgba(255,51,85,0.15); color:var(--green); }
  .pnl-neg { background:rgba(0,232,122,0.15); color:var(--red); }
  .empty-state { text-align:center; padding:40px 20px; color:var(--dim); }
  .empty-state .icon { font-size:36px; margin-bottom:10px; }

  /* NOTIFICATION */
  .notification { position:fixed; top:120px; left:14px; right:14px; padding:13px 18px; border-radius:13px; font-family:'Share Tech Mono',monospace; font-size:13px; z-index:999; text-align:center; pointer-events:none; animation:notifIn 0.3s cubic-bezier(0.34,1.56,0.64,1), notifOut 0.3s ease 2.7s forwards; }
  .notif-buy { background:rgba(255,51,85,0.2); border:1px solid var(--green); color:var(--green); }
  .notif-sell { background:rgba(0,232,122,0.2); border:1px solid var(--red); color:var(--red); }
  .notif-error { background:rgba(255,215,0,0.2); border:1px solid var(--yellow); color:var(--yellow); }
  @keyframes notifIn { from{opacity:0;transform:scale(0.95)} to{opacity:1;transform:scale(1)} }
  @keyframes notifOut { to{opacity:0} }
</style>
</head>
<body>

<!-- SPLASH SCREEN -->
<div id="splash" style="position:fixed;inset:0;z-index:99999;background:#000;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:0;">
  <div id="splash-main-title" style="font-family:'Share Tech Mono',monospace;font-size:32px;font-weight:bold;color:#00d4ff;letter-spacing:6px;line-height:1.3;text-align:center;">DAY TRADER</div>
  <div id="splash-divider" style="width:48px;height:2px;background:linear-gradient(90deg,transparent,#00d4ff,transparent);margin:28px 0 32px;"></div>

  <!-- TAP TO START -->
  <div id="splash-tap-screen" style="display:flex;flex-direction:column;align-items:center;cursor:pointer;" onclick="showModeSelect()">
    <div style="font-family:'Share Tech Mono',monospace;font-size:26px;font-weight:bold;color:#90c0d8;letter-spacing:3px;animation:blink 1.4s ease-in-out infinite;">TAP TO START</div>
  </div>

  <!-- ãƒ¢ãƒ¼ãƒ‰é¸æŠ -->
  <div id="splash-mode-select" style="display:none;flex-direction:column;gap:14px;width:260px;">
    <div onclick="launchApp('ranking')" style="padding:16px 0;text-align:center;border:1px solid #ff9500;border-radius:12px;background:rgba(255,149,0,0.06);cursor:pointer;">
      <div style="font-family:'Share Tech Mono',monospace;font-size:15px;color:#ff9500;letter-spacing:2px;margin-bottom:4px;">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰</div>
      <div style="font-size:11px;color:#4a6a80;">10åˆ†é–“ã§è³‡ç”£ã‚’å¢—ã‚„ã›ï¼</div>
    </div>
    <div onclick="launchApp('practice')" style="padding:16px 0;text-align:center;border:1px solid #1a4a60;border-radius:12px;background:rgba(0,212,255,0.06);cursor:pointer;">
      <div style="font-family:'Share Tech Mono',monospace;font-size:15px;color:#00d4ff;letter-spacing:2px;margin-bottom:4px;">ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰</div>
      <div style="font-size:11px;color:#4a6a80;">è‡ªç”±ã«å–å¼•ã‚’ç·´ç¿’</div>
    </div>
    <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º -->
    <div onclick="showSplashRankingPage()" style="padding:16px 0;text-align:center;border:1px solid #ff9500;border-radius:12px;background:rgba(255,149,0,0.06);cursor:pointer;">
      <div style="font-size:14px;color:#ff9500;letter-spacing:1px;">ğŸ† ä»Šé€±ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>
    </div>
  </div>

  <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°å…¨ç”»é¢ -->
  <div id="splash-ranking-page" style="display:none;flex-direction:column;position:absolute;inset:0;padding:20px 0;box-sizing:border-box;">
    <div style="font-family:'Share Tech Mono',monospace;font-size:32px;font-weight:bold;color:#00d4ff;letter-spacing:6px;text-align:center;margin-bottom:6px;">DAY TRADER</div>
    <div style="font-family:'Share Tech Mono',monospace;font-size:12px;color:#ff9500;text-align:center;letter-spacing:2px;margin-bottom:14px;">ğŸ† RANKING TOP 10</div>
    <div id="splash-ranking-full" style="flex:1;overflow-y:auto;border-top:1px solid #1a3a50;border-bottom:1px solid #1a3a50;">
      <div style="text-align:center;padding:12px;font-size:11px;color:var(--dim);">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
    <div onclick="document.getElementById('splash-ranking-page').style.display='none';document.getElementById('splash-mode-select').style.display='flex';document.getElementById('splash-main-title').style.display='';document.getElementById('splash-divider').style.display='';document.getElementById('splash-created-by').style.display='';"
      style="margin:14px 20px 0;padding:12px 0;text-align:center;border:1px solid #333;border-radius:10px;color:#666;font-family:'Share Tech Mono',monospace;font-size:13px;cursor:pointer;flex-shrink:0;">â† æˆ»ã‚‹</div>
  </div>

  <div id="splash-created-by" style="position:absolute;bottom:40px;font-family:'Share Tech Mono',monospace;font-size:12px;color:#1a3a50;letter-spacing:2px;">CREATED BY YM</div>
</div>

<style>
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.2} }
@keyframes fadeOut { from{opacity:1} to{opacity:0;pointer-events:none} }
</style>

<script>
let gameMode = 'practice';
let playerName = '';
let rankingTimer = null;
let rankingTimeLeft = 600; // 10åˆ†

function showModeSelect() {
  document.getElementById('splash-tap-screen').style.display = 'none';
  document.getElementById('splash-mode-select').style.display = 'flex';
}

// JSONBinè¨­å®š
const JSONBIN_BIN_ID = '69a3787fae596e708f536cb4';
const JSONBIN_KEY = '$2a$10$F4o1F24xzzTSnEUjdVdYCe5VOkpQmLiLTeb4li1Rgg1ftC5njwPEu';
const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`;

// é€±ã‚­ãƒ¼ï¼ˆæœˆæ›œèµ·ç‚¹ JSTï¼‰
function getWeekKey() {
  const now = new Date();
  const jst = new Date(now.getTime() + 9 * 60 * 60 * 1000);
  const day = jst.getUTCDay();
  const daysFromMonday = day === 0 ? 6 : day - 1;
  const monday = new Date(jst);
  monday.setUTCDate(jst.getUTCDate() - daysFromMonday);
  const y = monday.getUTCFullYear();
  const m = String(monday.getUTCMonth() + 1).padStart(2, '0');
  const d = String(monday.getUTCDate()).padStart(2, '0');
  return `${y}${m}${d}`;
}

function getWeekLabel() {
  const key = getWeekKey();
  return `${key.slice(0,4)}/${key.slice(4,6)}/${key.slice(6,8)}ã€œ`;
}

async function fetchBin() {
  const res = await fetch(`${JSONBIN_URL}/latest`, {
    headers: { 'X-Master-Key': JSONBIN_KEY, 'X-Bin-Meta': 'false' }
  });
  return await res.json();
}

async function updateBin(record) {
  await fetch(JSONBIN_URL, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json', 'X-Master-Key': JSONBIN_KEY },
    body: JSON.stringify(record)
  });
}

async function getRankingScores() {
  const record = await fetchBin();
  const key = getWeekKey();
  return record[key] || [];
}

async function loadSplashRanking() {
  const list = document.getElementById('splash-ranking-list');
  if (!list) return;
  try {
    const scores = await getRankingScores();
    if (scores.length === 0) { list.textContent = 'ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“'; return; }
    list.innerHTML = scores.map((s, i) => {
      const sign = s.pnl >= 0 ? '+' : '';
      const color = s.pnl >= 0 ? '#00e87a' : '#ff3355';
      const medal = i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : `${i+1}.`;
      return `<div style="display:flex;align-items:center;padding:6px 12px;border-bottom:1px solid rgba(255,255,255,0.04);">
        <div style="font-family:'Share Tech Mono',monospace;font-size:11px;color:#ff9500;width:24px;">${medal}</div>
        <div style="flex:1;font-size:11px;color:#d0e8f5;text-align:left;">${s.name}</div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:11px;color:${color};">${sign}Â¥${Math.abs(s.pnl).toLocaleString()}</div>
      </div>`;
    }).join('');
  } catch(e) { list.textContent = 'èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼'; }
}

async function showSplashRankingPage() {
  document.getElementById('splash-mode-select').style.display = 'none';
  document.getElementById('splash-ranking-page').style.display = 'flex';
  document.getElementById('splash-main-title').style.display = 'none';
  document.getElementById('splash-divider').style.display = 'none';
  document.getElementById('splash-created-by').style.display = 'none';
  const list = document.getElementById('splash-ranking-full');
  list.innerHTML = '<div style="text-align:center;padding:12px;font-size:11px;color:var(--dim);">èª­ã¿è¾¼ã¿ä¸­...</div>';
  try {
    const scores = await getRankingScores();
    const wl = getWeekLabel();
    if (scores.length === 0) {
      list.innerHTML = `<div style="text-align:center;padding:6px;font-size:9px;color:var(--dim);">ä»Šé€±: ${wl}</div><div style="text-align:center;padding:12px;font-size:11px;color:var(--dim);">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
      return;
    }
    list.innerHTML = `<div style="text-align:center;padding:6px;font-size:9px;color:var(--dim);border-bottom:1px solid rgba(255,255,255,0.05);">ä»Šé€±: ${wl}</div>` +
      scores.map((s, i) => {
        const sign = s.pnl >= 0 ? '+' : '';
        const color = s.pnl >= 0 ? '#00e87a' : '#ff3355';
        const medal = i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : `${i+1}.`;
        return `<div style="display:flex;align-items:center;padding:9px 14px;border-bottom:1px solid rgba(255,255,255,0.05);">
          <div style="font-family:'Share Tech Mono',monospace;font-size:13px;color:#ff9500;width:28px;">${medal}</div>
          <div style="flex:1;font-size:13px;color:#d0e8f5;">${s.name}</div>
          <div style="font-family:'Share Tech Mono',monospace;font-size:13px;color:${color};">${sign}Â¥${Math.abs(s.pnl).toLocaleString()}</div>
        </div>`;
      }).join('');
  } catch(e) { list.innerHTML = '<div style="text-align:center;padding:12px;font-size:11px;color:var(--dim);">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</div>'; }
}

function showRankingModeEntry() {}

function launchApp(mode) {
  gameMode = mode;
  const splash = document.getElementById('splash');
  splash.style.animation = 'fadeOut 0.5s ease forwards';
  setTimeout(() => {
    splash.remove();
    if (mode === 'ranking') startRankingTimer();
  }, 500);
}

function startRankingTimer() {
  // å…ˆã«ã‚²ãƒ¼ãƒ ã‚’ä¸€æ™‚åœæ­¢
  state.paused = true;

  // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
  const overlay = document.createElement('div');
  overlay.id = 'countdown-overlay';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:9998;display:flex;align-items:center;justify-content:center;';
  overlay.innerHTML = `<div id="countdown-num" style="font-family:'Share Tech Mono',monospace;font-size:120px;font-weight:bold;color:#ff9500;text-shadow:0 0 40px rgba(255,149,0,0.6);transition:transform 0.1s;">3</div>`;
  document.body.appendChild(overlay);

  const nums = ['3','2','1','START'];
  let i = 0;
  const el = () => document.getElementById('countdown-num');

  const tick = () => {
    i++;
    if (i >= nums.length) {
      overlay.remove();
      state.paused = false;
      // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
      document.getElementById('ranking-timer-wrap').style.display = 'block';
      rankingTimeLeft = 600;
      updateTimerDisplay();
      rankingTimer = setInterval(() => {
        rankingTimeLeft--;
        updateTimerDisplay();
        if (rankingTimeLeft <= 0) {
          clearInterval(rankingTimer);
          endRankingMode();
        }
      }, 1000);
      return;
    }
    const e = el();
    if (!e) return;
    e.style.transform = 'scale(1.3)';
    e.style.color = i === nums.length - 1 ? '#00d4ff' : '#ff9500';
    e.style.fontSize = i === nums.length - 1 ? '60px' : '120px';
    e.textContent = nums[i];
    setTimeout(() => { if(el()) el().style.transform = 'scale(1)'; }, 100);
    setTimeout(tick, 1000);
  };

  setTimeout(tick, 1000);
}

function updateTimerDisplay() {
  const el = document.getElementById('ranking-timer');
  if (!el) return;
  const m = Math.floor(rankingTimeLeft / 60).toString().padStart(2,'0');
  const s = (rankingTimeLeft % 60).toString().padStart(2,'0');
  el.textContent = `${m}:${s}`;
  el.style.color = rankingTimeLeft <= 60 ? '#ff3355' : '#ff9500';
}

async function endRankingMode() {
  let positionValue = 0;
  STOCKS.forEach(s => {
    const pos = state.positions[s.symbol];
    if (pos.qty > 0) positionValue += state.prices[s.symbol] * pos.qty;
  });
  const totalAsset = state.balance + positionValue;
  _finalPnl = totalAsset - 10_000_000;
  showRankingResult(_finalPnl);
}

async function showRankingResult(pnl) {
  const sign = pnl > 0 ? '+' : pnl < 0 ? '-' : 'Â±';
  const pnlColor = pnl > 0 ? '#ff3355' : pnl < 0 ? '#00e87a' : '#ffffff';
  const pnlText = `${sign}${Math.abs(pnl).toLocaleString()}å††`;

  let ranksIn = false;
  try {
    const scores = await getRankingScores();
    ranksIn = pnl > 0 && (scores.length < 10 || pnl > scores[scores.length - 1].pnl);
  } catch(e) {}

  const overlay = document.createElement('div');
  overlay.id = 'ranking-result-overlay';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.88);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;box-sizing:border-box;';

  const nameBlock = ranksIn ? `
    <div style="font-size:11px;color:#ff9500;margin-bottom:8px;">ğŸ‰ TOP10ãƒ©ãƒ³ã‚¯ã‚¤ãƒ³ï¼åå‰ã‚’ç™»éŒ²</div>
    <input id="ranking-name-input" type="text" maxlength="12" placeholder="YOUR NAME"
      style="width:100%;background:rgba(0,0,0,0.4);border:1px solid #ff9500;color:#fff;
             font-family:'Share Tech Mono',monospace;font-size:15px;padding:10px;
             border-radius:10px;outline:none;text-align:center;letter-spacing:2px;margin-bottom:5px;box-sizing:border-box;">
    <div style="font-size:10px;color:#4a6a80;margin-bottom:6px;">â€» å…¥åŠ›ã—ãŸåå‰ã¯å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å…¬é–‹ã•ã‚Œã¾ã™</div>
    <div id="ranking-name-result" style="font-size:12px;color:var(--dim);min-height:18px;margin-bottom:10px;"></div>
    <div style="display:flex;gap:8px;width:100%;">
      <div onclick="location.reload()" style="flex:1;padding:12px 0;border:1px solid #333;border-radius:10px;color:#666;font-family:'Share Tech Mono',monospace;font-size:12px;cursor:pointer;text-align:center;">ã‚‚ã†ä¸€åº¦</div>
      <div onclick="submitRankingFromOverlay(${pnl})" id="ranking-submit-btn" style="flex:1;padding:12px 0;border:1px solid #ff9500;border-radius:10px;color:#ff9500;font-family:'Share Tech Mono',monospace;font-size:12px;cursor:pointer;text-align:center;">ç™»éŒ²</div>
    </div>
  ` : `
    <div style="font-size:11px;color:var(--dim);margin-bottom:16px;">ä»Šé€±ã®ãƒ©ãƒ³ã‚¯å¤–ã§ã—ãŸ</div>
    <div onclick="location.reload()" style="width:100%;padding:12px 0;border:1px solid #333;border-radius:10px;color:#666;font-family:'Share Tech Mono',monospace;font-size:12px;cursor:pointer;text-align:center;box-sizing:border-box;">ã‚‚ã†ä¸€åº¦</div>
  `;

  overlay.innerHTML = `
    <div style="width:100%;max-width:300px;background:#0a1a28;border:1px solid #ff9500;border-radius:16px;padding:28px 20px;text-align:center;">
      <div style="font-family:'Share Tech Mono',monospace;font-size:11px;color:#ff9500;letter-spacing:3px;margin-bottom:16px;">RANKING MODE çµ‚äº†</div>
      <div style="font-size:11px;color:#4a6a80;margin-bottom:6px;">æœ€çµ‚æç›Š</div>
      <div style="font-family:'Share Tech Mono',monospace;font-size:30px;font-weight:bold;color:${pnlColor};margin-bottom:20px;">${pnlText}</div>
      ${nameBlock}
    </div>`;
  document.body.appendChild(overlay);
}

async function submitRankingFromOverlay(pnl) {
  const input = document.getElementById('ranking-name-input');
  const name = input ? input.value.trim() : '';
  if (!name) { if (input) input.style.borderColor = '#ff3355'; return; }
  const rank = await saveRankingWithName(name, pnl);
  const result = document.getElementById('ranking-name-result');
  if (result) result.innerHTML = `<span style="color:#ff9500;font-family:'Share Tech Mono',monospace;">${rank}ä½</span>ã§ç™»éŒ²ã—ã¾ã—ãŸï¼`;
  const btn = document.getElementById('ranking-submit-btn');
  if (btn) { btn.textContent = 'ã‚‚ã†ä¸€åº¦'; btn.onclick = () => location.reload(); }
}

async function saveRankingWithName(name, pnl) {
  try {
    const key = getWeekKey();
    const record = await fetchBin();
    let scores = record[key] || [];
    scores.push({ name, pnl, date: new Date().toLocaleDateString('ja-JP') });
    scores.sort((a,b) => b.pnl - a.pnl);
    scores = scores.slice(0, 10);
    record[key] = scores;
    await updateBin(record);
    playerName = name;
    return scores.findIndex(s => s.name === name && s.pnl === pnl) + 1;
  } catch(e) { return 0; }
}


</script>

<!-- HEADER -->
<div class="app-header">
  <div class="header-inner">
    <div class="logo">DAY TRADER</div>
    <div id="ranking-timer-wrap" style="display:none;font-family:'Share Tech Mono',monospace;font-size:13px;color:#ff9500;letter-spacing:2px;border:1px solid #ff9500;padding:4px 10px;border-radius:8px;">
      <span style="font-size:9px;color:#ff9500;display:block;text-align:center;letter-spacing:1px;">RANKING</span>
      <span id="ranking-timer">10:00</span>
    </div>
    <div style="text-align:right">
      <div class="header-balance" id="header-balance">Â¥10,000,000</div>
      <div class="header-change" id="header-change" style="color:var(--dim)">--</div>
    </div>
  </div>
</div>

<!-- TAB BAR -->
<div class="tab-bar">
  <div class="tab-item active" id="tab-home"><div class="tab-icon">ğŸ“Š</div><div>ãƒ›ãƒ¼ãƒ </div></div>
  <div class="tab-item" id="tab-chart"><div class="tab-icon">ğŸ“ˆ</div><div>ãƒãƒ£ãƒ¼ãƒˆ</div></div>
  <div class="tab-item" id="tab-board"><div class="tab-icon">ğŸ“‘</div><div>æ¿</div></div>
  <div class="tab-item" id="tab-trade"><div class="tab-icon">ğŸ’¹</div><div>æ³¨æ–‡</div></div>
  <div class="tab-item" id="tab-log"><div class="tab-icon">ğŸ“‹</div><div>å±¥æ­´</div></div>
</div>

<!-- HOME PAGE -->
<div class="scroll-container active" id="scroll-home">
  <div class="page">
    <div class="ticker-wrap"><div class="ticker-inner" id="ticker-inner"></div></div>
    <div class="stat-grid">
      <div class="stat-card"><div class="stat-card-label">è²·ä»˜ä½™åŠ›</div><div class="stat-card-value" id="st-balance">Â¥10,000,000</div></div>
      <div class="stat-card"><div class="stat-card-label">è©•ä¾¡æç›Š</div><div class="stat-card-value" id="st-unrealized">Â¥0</div></div>
      <div class="stat-card"><div class="stat-card-label">ç¢ºå®šæç›Š</div><div class="stat-card-value" id="st-realized">Â¥0</div></div>
      <div class="stat-card"><div class="stat-card-label">å‹ç‡</div><div class="stat-card-value" id="st-winrate">--</div></div>
    </div>
    <div style="display:flex;justify-content:flex-end;margin-bottom:12px;">
      <button class="ctrl-btn ctrl-reset" onclick="resetGame()">RESET</button>
    </div>
    <div class="card">
      <div class="card-title">éŠ˜æŸ„ä¸€è¦§</div>
      <div id="home-stock-list"></div>
    </div>
  </div>
</div>

<!-- TRADE PAGE -->
<div class="scroll-container" id="scroll-trade">
  <div class="page">
    <div class="chip-row" id="trade-chips" style="margin-bottom:12px;"></div>
    <div class="current-price-row">
      <span class="cp-label">ç¾åœ¨å€¤</span>
      <span class="cp-value" id="trade-price">--</span>
    </div>
    <div class="position-card">
      <div class="card-title">ä¿æœ‰ãƒã‚¸ã‚·ãƒ§ãƒ³</div>
      <div class="pos-grid">
        <div class="pos-item"><div class="label">ä¿æœ‰æ ªæ•°</div><div class="value" id="pos-qty">0 æ ª</div></div>
        <div class="pos-item"><div class="label">å¹³å‡å˜ä¾¡</div><div class="value" id="pos-avg">--</div></div>
        <div class="pos-item"><div class="label">è©•ä¾¡æç›Š</div><div class="value" id="pos-pnl">--</div></div>
        <div class="pos-item"><div class="label">æç›Šç‡</div><div class="value" id="pos-pct">--</div></div>
      </div>
    </div>
    <div class="card">
      <!-- æˆè¡Œãƒ»æŒ‡å€¤ãƒ»é€†æŒ‡å€¤åˆ‡æ›¿ -->
      <div class="card-title">æ³¨æ–‡ç¨®åˆ¥</div>
      <div style="display:flex;gap:6px;margin-bottom:10px;">
        <div id="order-type-market" onclick="setOrderType('market')"
          style="flex:1;padding:8px 0;text-align:center;border-radius:8px;font-family:'Share Tech Mono',monospace;font-size:13px;cursor:pointer;border:1.5px solid var(--accent);color:var(--accent);background:rgba(0,212,255,0.1);">æˆè¡Œ</div>
        <div id="order-type-limit" onclick="setOrderType('limit')"
          style="flex:1;padding:8px 0;text-align:center;border-radius:8px;font-family:'Share Tech Mono',monospace;font-size:13px;cursor:pointer;border:1px solid var(--border);color:var(--dim);background:transparent;">æŒ‡å€¤</div>
        <div id="order-type-stop" onclick="setOrderType('stop')"
          style="flex:1;padding:8px 0;text-align:center;border-radius:8px;font-family:'Share Tech Mono',monospace;font-size:13px;cursor:pointer;border:1px solid var(--border);color:var(--dim);background:transparent;">é€†æŒ‡å€¤</div>
      </div>
      <!-- æŒ‡å€¤ä¾¡æ ¼å…¥åŠ›ï¼ˆæŒ‡å€¤æ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
      <div id="limit-price-area" style="display:none;margin-bottom:10px;">
        <div style="font-size:10px;color:var(--dim);letter-spacing:1px;text-transform:uppercase;margin-bottom:6px;">æŒ‡å€¤ä¾¡æ ¼</div>
        <input type="number" id="limit-price-input" inputmode="numeric"
          style="width:100%;background:rgba(0,0,0,0.4);border:1px solid var(--accent);color:var(--text);
                 font-family:'Share Tech Mono',monospace;font-size:20px;padding:10px 14px;
                 border-radius:10px;outline:none;text-align:center;-webkit-appearance:none;margin-bottom:6px;">
        <div style="display:flex;gap:6px;">
          <div onclick="adjustLimitPrice(-10)" style="flex:1;padding:8px 0;text-align:center;background:rgba(0,0,0,0.3);border:1px solid var(--border);color:var(--dim);font-family:'Share Tech Mono',monospace;font-size:13px;border-radius:8px;cursor:pointer;">-10</div>
          <div onclick="adjustLimitPrice(-1)" style="flex:1;padding:8px 0;text-align:center;background:rgba(0,0,0,0.3);border:1px solid var(--border);color:var(--dim);font-family:'Share Tech Mono',monospace;font-size:13px;border-radius:8px;cursor:pointer;">-1</div>
          <div onclick="adjustLimitPrice(+1)" style="flex:1;padding:8px 0;text-align:center;background:rgba(0,0,0,0.3);border:1px solid var(--border);color:var(--dim);font-family:'Share Tech Mono',monospace;font-size:13px;border-radius:8px;cursor:pointer;">+1</div>
          <div onclick="adjustLimitPrice(+10)" style="flex:1;padding:8px 0;text-align:center;background:rgba(0,0,0,0.3);border:1px solid var(--border);color:var(--dim);font-family:'Share Tech Mono',monospace;font-size:13px;border-radius:8px;cursor:pointer;">+10</div>
        </div>
      </div>
      <!-- é€†æŒ‡å€¤ä¾¡æ ¼å…¥åŠ›ï¼ˆé€†æŒ‡å€¤æ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
      <div id="stop-price-area" style="display:none;margin-bottom:10px;">
        <div style="font-size:10px;color:#ff9500;letter-spacing:1px;text-transform:uppercase;margin-bottom:6px;">ãƒˆãƒªã‚¬ãƒ¼ä¾¡æ ¼</div>
        <input type="number" id="stop-price-input" inputmode="numeric"
          style="width:100%;background:rgba(0,0,0,0.4);border:1px solid #ff9500;color:var(--text);
                 font-family:'Share Tech Mono',monospace;font-size:20px;padding:10px 14px;
                 border-radius:10px;outline:none;text-align:center;-webkit-appearance:none;margin-bottom:6px;">
        <div style="display:flex;gap:6px;">
          <div onclick="adjustStopPrice(-10)" style="flex:1;padding:8px 0;text-align:center;background:rgba(0,0,0,0.3);border:1px solid var(--border);color:var(--dim);font-family:'Share Tech Mono',monospace;font-size:13px;border-radius:8px;cursor:pointer;">-10</div>
          <div onclick="adjustStopPrice(-1)" style="flex:1;padding:8px 0;text-align:center;background:rgba(0,0,0,0.3);border:1px solid var(--border);color:var(--dim);font-family:'Share Tech Mono',monospace;font-size:13px;border-radius:8px;cursor:pointer;">-1</div>
          <div onclick="adjustStopPrice(+1)" style="flex:1;padding:8px 0;text-align:center;background:rgba(0,0,0,0.3);border:1px solid var(--border);color:var(--dim);font-family:'Share Tech Mono',monospace;font-size:13px;border-radius:8px;cursor:pointer;">+1</div>
          <div onclick="adjustStopPrice(+10)" style="flex:1;padding:8px 0;text-align:center;background:rgba(0,0,0,0.3);border:1px solid var(--border);color:var(--dim);font-family:'Share Tech Mono',monospace;font-size:13px;border-radius:8px;cursor:pointer;">+10</div>
        </div>
      </div>
      <div class="card-title">æ³¨æ–‡æ•°é‡</div>
      <input type="number" class="qty-input" id="qty-input" value="100" min="100" step="100" readonly style="pointer-events:none;">
      <div class="qty-presets">
        <div class="qty-preset" onclick="adjustQty(-100)">-100</div>
        <div class="qty-preset" onclick="setQty(100)">100</div>
        <div class="qty-preset" onclick="adjustQty(+100)">+100</div>
        <div class="qty-preset" onclick="setQtyMax()">MAX</div>
      </div>
      <div class="order-details">
        <div class="ord-row"><span class="ord-label">æ³¨æ–‡ä¾¡æ ¼</span><span class="ord-value" id="ord-price">--</span></div>
        <div class="ord-row"><span class="ord-label">æ•°é‡</span><span class="ord-value" id="ord-qty">--</span></div>
        <div class="ord-row"><span class="ord-label">ç´„å®šé‡‘é¡</span><span class="ord-value" id="ord-total">--</span></div>
        <div class="ord-row"><span class="ord-label">æ‰‹æ•°æ–™</span><span class="ord-value" id="ord-fee">ãªã—</span></div>
      </div>
      <div class="trade-btns">
        <button class="btn-buy" onclick="executeTrade('buy')">BUY<span class="btn-sub">è²·ã„</span></button>
        <button class="btn-sell" onclick="executeTrade('sell')">SELL<span class="btn-sub">å£²ã‚Š</span></button>
      </div>
    </div>
  </div>
</div>

<!-- BOARD PAGE -->
<div class="scroll-container" id="scroll-board">
  <div class="page" style="padding-bottom:20px;">
    <!-- éŠ˜æŸ„ãƒãƒƒãƒ— -->
    <div class="chip-row" id="board-chips" style="margin-bottom:10px;"></div>
    <!-- éŠ˜æŸ„ãƒ»ç¾åœ¨å€¤ -->
    <div style="display:flex;align-items:baseline;gap:8px;margin-bottom:10px;">
      <span style="font-family:'Share Tech Mono',monospace;font-size:15px;color:var(--accent);" id="board-symbol">7203</span>
      <span style="font-size:11px;color:var(--dim);" id="board-name">ãƒˆãƒ¨ã‚¿è‡ªå‹•è»Š</span>
      <span style="font-family:'Share Tech Mono',monospace;font-size:22px;font-weight:bold;margin-left:4px;" id="board-price">--</span>
      <span class="change-badge" id="board-change-badge">--</span>
    </div>
    <!-- æ ªæ•°å…¥åŠ› -->
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
      <div style="font-size:11px;color:var(--dim);white-space:nowrap;">æ•°é‡</div>
      <input type="number" id="board-qty-input" value="100" min="100" step="100" readonly
        style="width:80px;background:rgba(0,0,0,0.4);border:1px solid var(--border);color:var(--text);
               font-family:'Share Tech Mono',monospace;font-size:14px;padding:7px 8px;
               border-radius:8px;outline:none;text-align:center;-webkit-appearance:none;flex-shrink:0;pointer-events:none;">
      <div style="display:flex;gap:5px;flex:1;">
        <div onclick="boardAdjustQty(-100)" style="flex:1;padding:7px 0;text-align:center;background:rgba(0,0,0,0.3);border:1px solid var(--border);color:var(--dim);font-family:'Share Tech Mono',monospace;font-size:12px;border-radius:8px;cursor:pointer;">-100</div>
        <div onclick="document.getElementById('board-qty-input').value=100" style="flex:1;padding:7px 0;text-align:center;background:rgba(0,0,0,0.3);border:1px solid var(--border);color:var(--dim);font-family:'Share Tech Mono',monospace;font-size:12px;border-radius:8px;cursor:pointer;">100</div>
        <div onclick="boardAdjustQty(+100)" style="flex:1;padding:7px 0;text-align:center;background:rgba(0,0,0,0.3);border:1px solid var(--border);color:var(--dim);font-family:'Share Tech Mono',monospace;font-size:12px;border-radius:8px;cursor:pointer;">+100</div>
      </div>
    </div>
    <!-- ã‚¿ãƒƒãƒ—èª¬æ˜ -->
    <div style="font-size:10px;color:var(--dim);text-align:center;margin-bottom:8px;">ç¾åœ¨å€¤ã‚ˆã‚Šä¸‹ã‚¿ãƒƒãƒ— â†’ æŒ‡å€¤BUY ï¼ ä¸Šã‚¿ãƒƒãƒ— â†’ æŒ‡å€¤SELL</div>
    <!-- æ¿ -->
    <div style="background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden;">
      <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
      <div style="display:grid;grid-template-columns:1fr 80px 1fr;gap:0;padding:7px 12px;border-bottom:1px solid var(--border);background:rgba(255,255,255,0.03);">
        <div style="font-size:10px;color:var(--dim);text-align:right;letter-spacing:1px;">å£²æ•°é‡</div>
        <div style="font-size:10px;color:var(--dim);text-align:center;letter-spacing:1px;">ä¾¡æ ¼</div>
        <div style="font-size:10px;color:var(--dim);text-align:left;letter-spacing:1px;">è²·æ•°é‡</div>
      </div>
      <!-- å£²æ¿ï¼ˆ10æ®µï¼‰ -->
      <div id="board-ask-rows"></div>
      <!-- ç¾å€¤è¡Œ -->
      <div style="display:grid;grid-template-columns:1fr 80px 1fr;padding:8px 12px;background:rgba(0,212,255,0.06);border-top:1px solid rgba(0,212,255,0.2);border-bottom:1px solid rgba(0,212,255,0.2);">
        <div></div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:13px;color:var(--accent);text-align:center;font-weight:bold;" id="board-mid-price">--</div>
        <div></div>
      </div>
      <!-- è²·æ¿ï¼ˆ10æ®µï¼‰ -->
      <div id="board-bid-rows"></div>
    </div>
  </div>
</div>

<!-- LOG PAGE -->
<div class="scroll-container" id="scroll-log">
  <div class="page">
    <!-- å¾…æ©Ÿæ³¨æ–‡ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div style="margin-bottom:12px;">
      <div style="font-size:13px;color:var(--dim);margin-bottom:8px;">å¾…æ©Ÿæ³¨æ–‡</div>
      <div id="pending-orders-list">
        <div class="empty-state" style="padding:14px 0;"><div style="font-size:11px;color:var(--dim);">å¾…æ©Ÿä¸­ã®æŒ‡å€¤æ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“</div></div>
      </div>
    </div>
    <div style="margin-bottom:12px;">
      <div style="font-size:13px;color:var(--dim)">ç´„å®šå±¥æ­´</div>
    </div>
    <div id="trade-log">
      <div class="empty-state"><div class="icon">ğŸ“‹</div><div>ã¾ã å–å¼•å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div></div>
    </div>
  </div>
</div>

<!-- CHART PAGE: flex column, fills remaining height -->
<div class="chart-container" id="chart-container">

  <!-- è¡Œ1: éŠ˜æŸ„ãƒ»æ ªä¾¡ ï¼‹ åˆ†è¶³åˆ‡æ›¿ï¼ˆç¸¦ï¼‰ï¼‹ æ•°é‡ãƒ»BUY/SELL -->
  <div style="display:flex;align-items:stretch;gap:8px;flex-shrink:0;">

    <!-- éŠ˜æŸ„ãƒ»æ ªä¾¡ -->
    <div style="flex:1;min-width:0;">
      <div style="display:flex;align-items:baseline;gap:5px;flex-wrap:wrap;">
        <span style="font-family:'Share Tech Mono',monospace;font-size:14px;color:var(--accent);" id="chart-symbol">7203</span>
        <span style="font-size:10px;color:var(--dim);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" id="chart-name">ãƒˆãƒ¨ã‚¿è‡ªå‹•è»Š</span>
      </div>
      <div style="display:flex;align-items:center;gap:6px;margin-top:3px;flex-wrap:wrap;">
        <span style="font-family:'Share Tech Mono',monospace;font-size:20px;font-weight:bold;" id="chart-price">--</span>
        <span class="change-badge" id="chart-change-badge">--</span>
      </div>
      <div style="display:flex;align-items:center;gap:8px;margin-top:4px;">
        <div style="font-size:11px;color:var(--dim);">ä¿æœ‰ <span style="font-family:'Share Tech Mono',monospace;color:var(--text);" id="ct-pos-qty">0æ ª</span> <span id="ct-pos-pnl" style="font-family:'Share Tech Mono',monospace;font-size:11px;"></span></div>
        <div style="width:1px;background:var(--border);height:11px;flex-shrink:0;"></div>
        <div style="font-size:11px;color:var(--dim);white-space:nowrap;">è²·ä»˜ä½™åŠ› <span style="font-family:'Share Tech Mono',monospace;color:var(--text);" id="ct-balance">--</span></div>
      </div>
    </div>

    <!-- åˆ†è¶³åˆ‡æ›¿ -->
    <div style="display:flex;flex-direction:column;gap:4px;flex-shrink:0;justify-content:center;">
      <button class="tf-btn active" onclick="setTF(60,this)" style="padding:8px 14px;font-size:13px;">1åˆ†</button>
      <button class="tf-btn" onclick="setTF(300,this)" style="padding:8px 14px;font-size:13px;">5åˆ†</button>
      <button class="tf-btn" onclick="setTF(900,this)" style="padding:8px 14px;font-size:13px;">15åˆ†</button>
    </div>

    <!-- æ•°é‡ + BUY/SELL -->
    <div style="display:flex;flex-direction:column;gap:4px;flex-shrink:0;justify-content:center;">
      <input type="number" id="chart-qty-input" value="100" min="100" step="100" readonly
        style="width:90px;background:rgba(0,0,0,0.4);border:1px solid var(--border);color:var(--text);
               font-family:'Share Tech Mono',monospace;font-size:16px;padding:8px 6px;
               border-radius:8px;outline:none;text-align:center;-webkit-appearance:none;pointer-events:none;">
      <div style="display:flex;gap:4px;">
        <button onclick="chartExecuteTrade('buy')"
          style="flex:1;padding:10px 6px;background:rgba(255,51,85,0.15);color:var(--green);
                 border:1.5px solid var(--green);border-radius:8px;font-family:'Share Tech Mono',monospace;
                 font-size:15px;font-weight:bold;cursor:pointer;letter-spacing:1px;">BUY</button>
        <button onclick="chartExecuteTrade('sell')"
          style="flex:1;padding:10px 6px;background:rgba(0,232,122,0.15);color:var(--red);
                 border:1.5px solid var(--red);border-radius:8px;font-family:'Share Tech Mono',monospace;
                 font-size:15px;font-weight:bold;cursor:pointer;letter-spacing:1px;">SELL</button>
      </div>
    </div>
  </div>

  <!-- è¡Œ3: æ ªæ•°ãƒœã‚¿ãƒ³ -->
  <div style="display:flex;gap:6px;flex-shrink:0;">
    <div onclick="chartAdjustQty(-100)" style="flex:1;padding:8px 0;text-align:center;background:rgba(0,0,0,0.3);border:1px solid var(--border);color:var(--dim);font-family:'Share Tech Mono',monospace;font-size:13px;border-radius:8px;cursor:pointer;">-100</div>
    <div onclick="chartSetQty(100)" style="flex:1;padding:8px 0;text-align:center;background:rgba(0,0,0,0.3);border:1px solid var(--border);color:var(--dim);font-family:'Share Tech Mono',monospace;font-size:13px;border-radius:8px;cursor:pointer;">100</div>
    <div onclick="chartAdjustQty(+100)" style="flex:1;padding:8px 0;text-align:center;background:rgba(0,0,0,0.3);border:1px solid var(--border);color:var(--dim);font-family:'Share Tech Mono',monospace;font-size:13px;border-radius:8px;cursor:pointer;">+100</div>
    <div onclick="chartSetQtyMax()" style="flex:1;padding:8px 0;text-align:center;background:rgba(0,0,0,0.3);border:1px solid var(--border);color:var(--dim);font-family:'Share Tech Mono',monospace;font-size:13px;border-radius:8px;cursor:pointer;">MAX</div>
  </div>

  <!-- è¡Œ3: éŠ˜æŸ„åˆ‡æ›¿ãƒãƒƒãƒ— -->
  <div class="chip-row" id="stock-chips" style="flex-shrink:0;"></div>

  <!-- è¡Œ4: ãƒãƒ£ãƒ¼ãƒˆï¼ˆæ®‹ã‚Šå…¨éƒ¨ï¼‰ -->
  <div style="flex:1;min-height:0;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:8px;overflow:hidden;">
    <canvas id="chart" style="display:block;width:100%;height:100%;"></canvas>
  </div>

  <!-- è¡Œ5: ä¸€æ™‚åœæ­¢ -->
  <div style="display:flex;align-items:center;gap:8px;flex-shrink:0;">
    <button class="ctrl-btn ctrl-pause" id="pause-btn" onclick="togglePause()">â¸ åœæ­¢</button>
  </div>

</div>

<script>
const STOCKS = [
  { symbol:'7203', name:'ãƒˆãƒ¨ã‚¿è‡ªå‹•è»Š',    basePrice:3825,  vol:0.0005 },
  { symbol:'6758', name:'ã‚½ãƒ‹ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—',   basePrice:3552,  vol:0.000625 },
  { symbol:'9984', name:'ã‚½ãƒ•ãƒˆãƒãƒ³ã‚¯G',    basePrice:4326,  vol:0.00075 },
  { symbol:'4063', name:'ä¿¡è¶ŠåŒ–å­¦',         basePrice:4932,  vol:0.0005 },
  { symbol:'8035', name:'æ±äº¬ã‚¨ãƒ¬ã‚¯ãƒˆãƒ­ãƒ³', basePrice:45310, vol:0.0007 },
  { symbol:'6857', name:'ã‚¢ãƒ‰ãƒãƒ³ãƒ†ã‚¹ãƒˆ',   basePrice:28125, vol:0.0004 },
  { symbol:'6920', name:'ãƒ¬ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒƒã‚¯',   basePrice:33660, vol:0.0009 },
  { symbol:'6861', name:'ã‚­ãƒ¼ã‚¨ãƒ³ã‚¹',       basePrice:66060, vol:0.0005 },
  { symbol:'6146', name:'ãƒ‡ã‚£ã‚¹ã‚³',         basePrice:75500, vol:0.0008 },
  { symbol:'6762', name:'TDK',              basePrice:2424,  vol:0.0006 },
  { symbol:'5108', name:'ãƒ–ãƒªãƒ‚ã‚¹ãƒˆãƒ³',     basePrice:3796,  vol:0.0005 },
];

const state = {
  balance:10_000_000, positions:{}, realizedPnL:0, wins:0, losses:0,
  prices:{}, history:{}, trends:{},
  currentSymbol:'7203', tf:60, paused:false, speed:1,
};

STOCKS.forEach(s => {
  state.prices[s.symbol] = s.basePrice;
  state.history[s.symbol] = genHistory(s.basePrice, s.vol);
  state.positions[s.symbol] = {qty:0, avgPrice:0};
  state.trends[s.symbol] = 0;
});

function genHistory(base, vol) {
  const bars=[], now=Date.now(); let p=base;
  const v=vol;
  for (let i=300; i>=0; i--) {
    const ch=(Math.random()-0.5)*v*p, o=p, c=p+ch;
    bars.push({o, h:Math.max(o,c)+Math.random()*v*p*0.5, l:Math.min(o,c)-Math.random()*v*p*0.5, c, t:now-i*60000});
    p=c;
  }
  return bars;
}

function updatePrices() {
  STOCKS.forEach(s => {
    if (Math.random()<0.02) state.trends[s.symbol]=(Math.random()-0.5)*0.0002;
    const p=state.prices[s.symbol];
    const np=p*(1+state.trends[s.symbol]+(Math.random()-0.5)*s.vol);
    state.prices[s.symbol]=Math.max(np,1);
    const hist=state.history[s.symbol], last=hist[hist.length-1], now=Date.now();
    if (now-last.t > state.tf*1000) {
      hist.push({o:np,h:np,l:np,c:np,t:now});
      if (hist.length>300) hist.shift();
    } else { last.c=np; last.h=Math.max(last.h,np); last.l=Math.min(last.l,np); }
  });
  if (state.pendingOrders && state.pendingOrders.length > 0) checkPendingOrders();
}

// CHART
const canvas=document.getElementById('chart');
const ctx=canvas.getContext('2d');

function drawChart() {
  const raw=state.history[state.currentSymbol];
  // TFã«å¿œã˜ã¦ãƒãƒ¼ã‚’é›†è¨ˆ
  const tfSec=state.tf;
  const grouped=[];
  raw.forEach(b=>{
    const key=Math.floor(b.t/(tfSec*1000));
    const last=grouped[grouped.length-1];
    if (last && last._key===key) {
      last.c=b.c; last.h=Math.max(last.h,b.h); last.l=Math.min(last.l,b.l);
    } else {
      grouped.push({o:b.o,h:b.h,l:b.l,c:b.c,t:b.t,_key:key});
    }
  });
  const hist=grouped;
  const W=canvas.clientWidth, H=canvas.clientHeight;
  if (!W||!H) return;
  const dpr=devicePixelRatio||1;
  canvas.width=W*dpr; canvas.height=H*dpr;
  ctx.scale(dpr,dpr);
  ctx.fillStyle='#0f2030'; ctx.fillRect(0,0,W,H);

  const visN=Math.min(60,hist.length), bars=hist.slice(-visN);
  const prices=bars.flatMap(b=>[b.h,b.l]);
  const minP=Math.min(...prices)*0.999, maxP=Math.max(...prices)*1.001, range=maxP-minP||1;
  const pL=6,pR=54,pT=8,pB=18, cW=W-pL-pR, cH=H-pT-pB;
  const toY=p=>pT+cH-(p-minP)/range*cH, bW=cW/visN;

  for (let i=0;i<=4;i++) {
    const y=pT+cH/4*i;
    ctx.strokeStyle='rgba(26,58,82,0.4)'; ctx.lineWidth=0.5;
    ctx.beginPath(); ctx.moveTo(pL,y); ctx.lineTo(W-pR,y); ctx.stroke();
    ctx.fillStyle='#4a6a80'; ctx.font='10px Share Tech Mono'; ctx.textAlign='left';
    ctx.fillText(Math.round(maxP-range/4*i).toLocaleString(), W-pR+4, y+4);
  }

  // MA5ï¼ˆçŸ­æœŸãƒ»ã‚·ã‚¢ãƒ³ï¼‰
  if (bars.length>=5) {
    ctx.strokeStyle='rgba(0,212,255,0.7)'; ctx.lineWidth=1.2; ctx.beginPath();
    for (let i=4;i<bars.length;i++) {
      const ma=bars.slice(i-4,i+1).reduce((s,b)=>s+b.c,0)/5;
      const x=pL+(i+0.5)*bW;
      if (i===4) ctx.moveTo(x,toY(ma)); else ctx.lineTo(x,toY(ma));
    }
    ctx.stroke();
  }

  // MA25ï¼ˆä¸­æœŸãƒ»ã‚´ãƒ¼ãƒ«ãƒ‰ï¼‰
  if (bars.length>=25) {
    ctx.strokeStyle='rgba(255,215,0,0.7)'; ctx.lineWidth=1.5; ctx.beginPath();
    for (let i=24;i<bars.length;i++) {
      const ma=bars.slice(i-24,i+1).reduce((s,b)=>s+b.c,0)/25;
      const x=pL+(i+0.5)*bW;
      if (i===24) ctx.moveTo(x,toY(ma)); else ctx.lineTo(x,toY(ma));
    }
    ctx.stroke();
  }

  // MA75ï¼ˆé•·æœŸãƒ»ã‚ªãƒ¬ãƒ³ã‚¸ï¼‰
  if (bars.length>=75) {
    ctx.strokeStyle='rgba(255,140,0,0.7)'; ctx.lineWidth=1.8; ctx.beginPath();
    for (let i=74;i<bars.length;i++) {
      const ma=bars.slice(i-74,i+1).reduce((s,b)=>s+b.c,0)/75;
      const x=pL+(i+0.5)*bW;
      if (i===74) ctx.moveTo(x,toY(ma)); else ctx.lineTo(x,toY(ma));
    }
    ctx.stroke();
  }

  bars.forEach((bar,i) => {
    const x=pL+i*bW, bW2=Math.max(bW*0.75,2), bX=x+(bW-bW2)/2;
    const isUp=bar.c>=bar.o, color=isUp?'#ff3355':'#00e87a';
    ctx.strokeStyle=color; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(x+bW/2,toY(bar.h)); ctx.lineTo(x+bW/2,toY(bar.l)); ctx.stroke();
    const bt=toY(Math.max(bar.o,bar.c)), bh=Math.max(toY(Math.min(bar.o,bar.c))-bt,1);
    ctx.fillStyle=isUp?'rgba(255,51,85,0.85)':'rgba(0,232,122,0.85)';
    ctx.fillRect(bX,bt,bW2,bh);
  });

  const pos=state.positions[state.currentSymbol];
  if (pos&&pos.qty>0) {
    const ay=toY(pos.avgPrice);
    ctx.strokeStyle='rgba(255,215,0,0.9)'; ctx.lineWidth=1.5; ctx.setLineDash([6,4]);
    ctx.beginPath(); ctx.moveTo(pL,ay); ctx.lineTo(W-pR,ay); ctx.stroke();
    ctx.setLineDash([]); ctx.fillStyle='rgba(255,215,0,1)'; ctx.font='9px Share Tech Mono';
    ctx.fillText('avg', W-pR+4, ay-2);
  }
}

// UI
function updateUI() {
  const price=state.prices[state.currentSymbol];
  const stock=STOCKS.find(s=>s.symbol===state.currentSymbol);
  let unreal=0, positionValue=0;
  STOCKS.forEach(s=>{ const pos=state.positions[s.symbol]; if(pos.qty>0){ unreal+=(state.prices[s.symbol]-pos.avgPrice)*pos.qty; positionValue+=state.prices[s.symbol]*pos.qty; }});

  document.getElementById('header-balance').textContent='Â¥'+Math.round(state.balance+positionValue).toLocaleString();
  const totalPnL=unreal+state.realizedPnL, hc=document.getElementById('header-change');
  hc.textContent=(totalPnL>=0?'+':'')+'Â¥'+Math.round(totalPnL).toLocaleString();
  hc.className='header-change '+(totalPnL>0?'up':totalPnL<0?'down':'');

  document.getElementById('st-balance').textContent='Â¥'+Math.round(state.balance).toLocaleString();
  const ure=document.getElementById('st-unrealized');
  ure.textContent=(unreal>=0?'+':'')+'Â¥'+Math.round(unreal).toLocaleString();
  ure.className='stat-card-value '+(unreal>0?'up':unreal<0?'down':'');
  const rle=document.getElementById('st-realized');
  rle.textContent=(state.realizedPnL>=0?'+':'')+'Â¥'+Math.round(state.realizedPnL).toLocaleString();
  rle.className='stat-card-value '+(state.realizedPnL>0?'up':state.realizedPnL<0?'down':'');
  const tot=state.wins+state.losses;
  document.getElementById('st-winrate').textContent=tot>0?Math.round(state.wins/tot*100)+'%':'--';

  // home list
  const listEl=document.getElementById('home-stock-list'); listEl.innerHTML='';
  STOCKS.forEach(s=>{
    const p=state.prices[s.symbol], hist=state.history[s.symbol];
    const open=hist.length>50?hist[hist.length-50].o:hist[0].o;
    const ch=p-open, pct=(ch/open*100).toFixed(2), cls=ch>=0?'up':'down', sign=ch>=0?'+':'';
    const pos=state.positions[s.symbol];
    const row=document.createElement('div');
    row.className='stock-row'+(s.symbol===state.currentSymbol?' selected':'');
    row.innerHTML=`
      <div class="stock-left">
        <div class="stock-badge ${ch>=0?'up-badge':'down-badge'}">${s.symbol.slice(-2)}</div>
        <div class="stock-info">
          <div class="sym ${cls}">${s.symbol}</div>
          <div class="nm">${s.name}${pos.qty>0?` <span style="color:var(--yellow);font-size:10px">â—${pos.qty}æ ª</span>`:''}</div>
        </div>
      </div>
      <div class="stock-right">
        <div class="pr ${cls}">${Math.round(p).toLocaleString()}</div>
        <div class="pch ${cls}">${sign}${pct}%</div>
      </div>`;
    row.onclick=()=>selectStock(s.symbol);
    listEl.appendChild(row);
  });

  // chart header
  const hist=state.history[state.currentSymbol];
  const open=hist.length>50?hist[hist.length-50].o:hist[0].o;
  const ch=price-open, pct=(ch/open*100).toFixed(2), sign=ch>=0?'+':'';
  document.getElementById('chart-symbol').textContent=state.currentSymbol;
  document.getElementById('chart-name').textContent=stock.name;
  const cpEl=document.getElementById('chart-price');
  cpEl.textContent=Math.round(price).toLocaleString();
  cpEl.className=ch>=0?'up':'down';
  const cbEl=document.getElementById('chart-change-badge');
  cbEl.textContent=`${sign}${Math.round(ch).toLocaleString()} (${sign}${pct}%)`;
  cbEl.className='change-badge '+(ch>=0?'change-up':'change-down');

  // chips
  ['stock-chips','trade-chips'].forEach(id=>{
    const el=document.getElementById(id); if(!el) return;
    el.innerHTML='';
    STOCKS.forEach(s=>{
      const chip=document.createElement('div');
      chip.className='chip'+(s.symbol===state.currentSymbol?' active':'');
      chip.textContent=id==='stock-chips'||id==='trade-chips'?s.name:s.symbol;
      chip.addEventListener('touchstart',function(e){e.preventDefault();selectStock(s.symbol);},{passive:false});
      chip.onclick=()=>selectStock(s.symbol);
      el.appendChild(chip);
    });
  });

  // trade page
  const tp=document.getElementById('trade-price');
  tp.textContent=Math.round(price).toLocaleString()+' å††';
  tp.className='cp-value '+(ch>=0?'up':'down');
  const pos=state.positions[state.currentSymbol];
  if (pos.qty>0) {
    const pnl=(price-pos.avgPrice)*pos.qty, pct2=((price-pos.avgPrice)/pos.avgPrice*100).toFixed(2);
    const pc=pnl>=0?'up':'down', sg=pnl>=0?'+':'';
    document.getElementById('pos-qty').textContent=pos.qty.toLocaleString()+' æ ª';
    document.getElementById('pos-avg').textContent=Math.round(pos.avgPrice).toLocaleString()+' å††';
    document.getElementById('pos-pnl').innerHTML=`<span class="${pc}">${sg}Â¥${Math.round(pnl).toLocaleString()}</span>`;
    document.getElementById('pos-pct').innerHTML=`<span class="${pc}">${sg}${pct2}%</span>`;
  } else {
    document.getElementById('pos-qty').textContent='0 æ ª';
    document.getElementById('pos-avg').textContent='--';
    document.getElementById('pos-pnl').textContent='--';
    document.getElementById('pos-pct').textContent='--';
  }

  // chart panel
  document.getElementById('ct-balance').textContent='Â¥'+Math.round(state.balance).toLocaleString();
  if (pos.qty>0) {
    const pnl=(price-pos.avgPrice)*pos.qty;
    document.getElementById('ct-pos-qty').textContent=pos.qty.toLocaleString()+'æ ª';
    document.getElementById('ct-pos-pnl').innerHTML=`<span class="${pnl>=0?'up':'down'}">${pnl>=0?'+':''}Â¥${Math.round(pnl).toLocaleString()}</span>`;
  } else {
    document.getElementById('ct-pos-qty').textContent='0æ ª';
    document.getElementById('ct-pos-pnl').textContent='';
  }

  updateOrderSummary();
  updateTicker();
  renderPendingOrders();
}

// æ³¨æ–‡ã‚¿ã‚¤ãƒ—ç®¡ç†
state.orderType = 'market'; // 'market' or 'limit'
state.pendingOrders = []; // {type, symbol, qty, limitPrice}

function setOrderType(type) {
  state.orderType = type;
  const isLimit = type === 'limit';
  const isStop  = type === 'stop';
  document.getElementById('limit-price-area').style.display = isLimit ? 'block' : 'none';
  document.getElementById('stop-price-area').style.display  = isStop  ? 'block' : 'none';

  const activeStyle  = (color, bg) => `flex:1;padding:8px 0;text-align:center;border-radius:8px;font-family:'Share Tech Mono',monospace;font-size:13px;cursor:pointer;border:1.5px solid ${color};color:${color};background:${bg};`;
  const inactiveStyle = `flex:1;padding:8px 0;text-align:center;border-radius:8px;font-family:'Share Tech Mono',monospace;font-size:13px;cursor:pointer;border:1px solid var(--border);color:var(--dim);background:transparent;`;

  document.getElementById('order-type-market').style.cssText = type==='market' ? activeStyle('var(--accent)','rgba(0,212,255,0.1)') : inactiveStyle;
  document.getElementById('order-type-limit').style.cssText  = isLimit          ? activeStyle('var(--accent)','rgba(0,212,255,0.1)') : inactiveStyle;
  document.getElementById('order-type-stop').style.cssText   = isStop           ? activeStyle('#ff9500','rgba(255,149,0,0.1)')        : inactiveStyle;

  if (isLimit) document.getElementById('limit-price-input').value = Math.round(state.prices[state.currentSymbol]);
  if (isStop)  document.getElementById('stop-price-input').value  = Math.round(state.prices[state.currentSymbol]);
  updateOrderSummary();
}

function adjustLimitPrice(d) {
  const el = document.getElementById('limit-price-input');
  el.value = Math.max(1, (parseInt(el.value) || 0) + d);
  updateOrderSummary();
}

function adjustStopPrice(d) {
  const el = document.getElementById('stop-price-input');
  el.value = Math.max(1, (parseInt(el.value) || 0) + d);
  updateOrderSummary();
}

function checkPendingOrders() {
  state.pendingOrders = state.pendingOrders.filter(order => {
    const price = state.prices[order.symbol];
    let hit = false;
    if (order.orderType === 'limit') {
      // æŒ‡å€¤ï¼šè²·ã„ã¯ä¾¡æ ¼ãŒæŒ‡å€¤ä»¥ä¸‹ã€å£²ã‚Šã¯ä¾¡æ ¼ãŒæŒ‡å€¤ä»¥ä¸Šã§ç´„å®š
      hit = order.type === 'buy' ? price <= order.limitPrice : price >= order.limitPrice;
      if (hit) {
        _trade(order.type, order.qty, order.symbol, order.limitPrice);
        showNotif(`æŒ‡å€¤${order.type==='buy'?'è²·':'å£²'}ã„ç´„å®š ${order.symbol} @${order.limitPrice.toLocaleString()}å††`, order.type==='buy'?'buy':'sell');
      }
    } else if (order.orderType === 'stop') {
      // é€†æŒ‡å€¤ï¼šè²·ã„ã¯ä¾¡æ ¼ãŒæŒ‡å€¤ä»¥ä¸Šã€å£²ã‚Šã¯ä¾¡æ ¼ãŒæŒ‡å€¤ä»¥ä¸‹ã§ãƒˆãƒªã‚¬ãƒ¼â†’æˆè¡Œç´„å®š
      hit = order.type === 'buy' ? price >= order.stopPrice : price <= order.stopPrice;
      if (hit) {
        _trade(order.type, order.qty, order.symbol, price);
        showNotif(`é€†æŒ‡å€¤${order.type==='buy'?'è²·':'å£²'}ã„ç´„å®š ${order.symbol} @${Math.round(price).toLocaleString()}å††`, order.type==='buy'?'buy':'sell');
      }
    }
    return !hit;
  });
}

function updateOrderSummary() {
  const isLimit = state.orderType === 'limit';
  const isStop  = state.orderType === 'stop';
  const price = isLimit
    ? (parseInt(document.getElementById('limit-price-input')?.value) || state.prices[state.currentSymbol])
    : isStop
    ? (parseInt(document.getElementById('stop-price-input')?.value) || state.prices[state.currentSymbol])
    : state.prices[state.currentSymbol];
  const qty = parseInt(document.getElementById('qty-input').value) || 0;
  const total = price * qty;
  const label = isLimit ? ' (æŒ‡å€¤)' : isStop ? ' (é€†æŒ‡å€¤)' : ' (æˆè¡Œ)';
  document.getElementById('ord-price').textContent = Math.round(price).toLocaleString() + ' å††' + label;
  document.getElementById('ord-qty').textContent = qty.toLocaleString() + ' æ ª';
  document.getElementById('ord-total').textContent = 'Â¥' + Math.round(total).toLocaleString();
  document.getElementById('ord-fee').textContent = 'ãªã—';
}

function renderPendingOrders() {
  const el = document.getElementById('pending-orders-list');
  if (!el) return;
  if (!state.pendingOrders || state.pendingOrders.length === 0) {
    el.innerHTML = '<div class="empty-state" style="padding:14px 0;"><div style="font-size:11px;color:var(--dim);">å¾…æ©Ÿä¸­ã®æŒ‡å€¤æ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“</div></div>';
    return;
  }
  el.innerHTML = state.pendingOrders.map((o, i) => {
    const isBuy = o.type === 'buy';
    const isStop = o.orderType === 'stop';
    const name = STOCKS.find(s => s.symbol === o.symbol)?.name || o.symbol;
    const borderColor = isStop ? '#ff9500' : (isBuy ? 'var(--green)' : 'var(--red)');
    const bg = isStop ? 'rgba(255,149,0,0.08)' : (isBuy ? 'rgba(255,51,85,0.08)' : 'rgba(0,232,122,0.08)');
    const typeLabel = isStop ? (isBuy ? 'â–² é€†æŒ‡å€¤BUY' : 'â–¼ é€†æŒ‡å€¤SELL') : (isBuy ? 'â–² BUY' : 'â–¼ SELL');
    const priceLabel = isStop ? `ãƒˆãƒªã‚¬ãƒ¼ ${o.stopPrice.toLocaleString()}å††` : `æŒ‡å€¤ ${o.limitPrice.toLocaleString()}å††`;
    return `<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-radius:10px;margin-bottom:6px;background:${bg};border-left:3px solid ${borderColor};">
      <div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:12px;color:${borderColor};">${typeLabel} Â· ${name}</div>
        <div style="font-size:11px;color:var(--dim);margin-top:2px;">${priceLabel} Ã— ${o.qty.toLocaleString()}æ ª</div>
      </div>
      <div onclick="cancelPendingOrder(${i})" style="padding:6px 12px;border:1px solid var(--dim);border-radius:8px;font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--dim);cursor:pointer;">å–æ¶ˆ</div>
    </div>`;
  }).join('');
}

function cancelPendingOrder(index) {
  state.pendingOrders.splice(index, 1);
  renderPendingOrders();
  showNotif('æŒ‡å€¤æ³¨æ–‡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ', 'error');
}

function renderBoard() {
  const sym = state.currentSymbol;
  const price = state.prices[sym];
  const stock = STOCKS.find(s => s.symbol === sym);

  // ãƒ˜ãƒƒãƒ€ãƒ¼æ›´æ–°
  document.getElementById('board-symbol').textContent = sym;
  document.getElementById('board-name').textContent = stock?.name || '';
  document.getElementById('board-mid-price').textContent = Math.round(price).toLocaleString();
  const hist = state.history[sym];
  const open = hist.length > 50 ? hist[hist.length-50].o : hist[0].o;
  const ch = price - open, pct = (ch/open*100).toFixed(2), sign = ch>=0?'+':'';
  const cbEl = document.getElementById('board-change-badge');
  cbEl.textContent = `${sign}${Math.round(ch).toLocaleString()} (${sign}${pct}%)`;
  cbEl.className = 'change-badge ' + (ch>=0?'change-up':'change-down');
  const priceEl = document.getElementById('board-price');
  priceEl.textContent = Math.round(price).toLocaleString();
  priceEl.className = ch>=0?'up':'down';

  // æ¿ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆï¼ˆå®‰å®šã—ãŸæ•°é‡ï¼‹å¾®å¤‰å‹•ï¼‰
  const tick = 1;
  const asks = [], bids = [];
  // seedãƒ™ãƒ¼ã‚¹ã§å®‰å®šã—ãŸæ•°é‡ã‚’ç”Ÿæˆï¼ˆä¾¡æ ¼ã‚’seedã«ä½¿ç”¨ï¼‰
  for (let i = 1; i <= 10; i++) {
    const p = Math.round((price + tick * i) / tick) * tick;
    const seed = (p * 7 + i * 13) % 900;
    const base = (seed + 100) * 100;
    const jitter = Math.floor((Math.random() - 0.5) * 200) * 100;
    asks.push({price: p, qty: Math.max(100, base + jitter)});
  }
  for (let i = 1; i <= 10; i++) {
    const p = Math.round((price - tick * i) / tick) * tick;
    const seed = (p * 11 + i * 7) % 900;
    const base = (seed + 100) * 100;
    const jitter = Math.floor((Math.random() - 0.5) * 200) * 100;
    bids.push({price: p, qty: Math.max(100, base + jitter)});
  }

  const maxQty = Math.max(...asks.map(a=>a.qty), ...bids.map(b=>b.qty));

  // å£²æ¿ï¼ˆé«˜ã„é †ã«ä¸¦ã¹ã‚‹ï¼‰
  const askRows = document.getElementById('board-ask-rows');
  askRows.innerHTML = [...asks].reverse().map(a => {
    const barW = Math.round(a.qty / maxQty * 100);
    return `<div onclick="setBoardPrice(${a.price},'ask')" style="display:grid;grid-template-columns:1fr 80px 1fr;align-items:center;padding:5px 12px;border-bottom:1px solid rgba(255,255,255,0.04);cursor:pointer;position:relative;">
      <div style="text-align:right;position:relative;z-index:1;">
        <div style="position:absolute;right:0;top:0;bottom:0;background:rgba(0,232,122,0.12);width:${barW}%;"></div>
        <span style="font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--green);position:relative;">${a.qty.toLocaleString()}</span>
      </div>
      <div style="font-family:'Share Tech Mono',monospace;font-size:13px;color:var(--green);text-align:center;">${a.price.toLocaleString()}</div>
      <div></div>
    </div>`;
  }).join('');

  // è²·æ¿
  const bidRows = document.getElementById('board-bid-rows');
  bidRows.innerHTML = bids.map(b => {
    const barW = Math.round(b.qty / maxQty * 100);
    return `<div onclick="setBoardPrice(${b.price},'bid')" style="display:grid;grid-template-columns:1fr 80px 1fr;align-items:center;padding:5px 12px;border-bottom:1px solid rgba(255,255,255,0.04);cursor:pointer;">
      <div></div>
      <div style="font-family:'Share Tech Mono',monospace;font-size:13px;color:var(--red);text-align:center;">${b.price.toLocaleString()}</div>
      <div style="text-align:left;position:relative;">
        <div style="position:absolute;left:0;top:0;bottom:0;background:rgba(255,51,85,0.12);width:${barW}%;"></div>
        <span style="font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--red);position:relative;">${b.qty.toLocaleString()}</span>
      </div>
    </div>`;
  }).join('');

  // éŠ˜æŸ„ãƒãƒƒãƒ—
  const el = document.getElementById('board-chips');
  if (el) {
    el.innerHTML = '';
    STOCKS.forEach(s => {
      const chip = document.createElement('div');
      chip.className = 'chip' + (s.symbol===state.currentSymbol?' active':'');
      chip.textContent = s.name;
      chip.addEventListener('touchstart', function(e){e.preventDefault();selectStock(s.symbol);},{passive:false});
      chip.onclick = () => selectStock(s.symbol);
      el.appendChild(chip);
    });
  }
}

function boardAdjustQty(d) {
  const el = document.getElementById('board-qty-input');
  el.value = Math.max(1, (parseInt(el.value) || 0) + d);
}

function setBoardPrice(price, side) {
  const currentPrice = state.prices[state.currentSymbol];
  // ç¾åœ¨å€¤ã‚ˆã‚Šä¸‹â†’æŒ‡å€¤BUYã€ä¸Šâ†’æŒ‡å€¤SELL
  const type = price < currentPrice ? 'buy' : 'sell';
  const qty = parseInt(document.getElementById('board-qty-input').value) || 100;

  if (type === 'sell') {
    const pos = state.positions[state.currentSymbol];
    const pendingSellQty = state.pendingOrders.filter(o => o.type==='sell' && o.symbol===state.currentSymbol).reduce((s,o)=>s+o.qty, 0);
    if (qty > (pos.qty - pendingSellQty)) {
      showNotif(`å£²ã‚Šæ³¨æ–‡è¶…é (ä¿æœ‰${pos.qty}æ ª)`, 'error');
      return;
    }
  }

  state.pendingOrders.push({orderType:'limit', type, symbol: state.currentSymbol, qty, limitPrice: price});
  renderPendingOrders();
  const label = type === 'buy' ? 'æŒ‡å€¤BUY' : 'æŒ‡å€¤SELL';
  showNotif(`${label} @${price.toLocaleString()}å†† Ã— ${qty}æ ª`, type==='buy'?'buy':'sell');
}

function updateTicker() {
  let html='';
  STOCKS.forEach(s=>{
    const p=state.prices[s.symbol], hist=state.history[s.symbol];
    const open=hist.length>50?hist[hist.length-50].o:hist[0].o;
    const ch=p-open, pct=(ch/open*100).toFixed(2), cls=ch>=0?'up':'down', sign=ch>=0?'+':'';
    html+=`<span class="ticker-item"><span class="${cls}">${s.name}</span> <span class="${cls}">${Math.round(p).toLocaleString()}</span> <span class="${cls}">${sign}${pct}%</span></span>`;
  });
  document.getElementById('ticker-inner').innerHTML=html+html;
}

function selectStock(sym) { state.currentSymbol=sym; updateUI(); drawChart(); }

function snapQty(el) {
  const v = parseInt(el.value) || 100;
  el.value = Math.max(100, Math.round(v / 100) * 100);
}

function adjustQty(d){const el=document.getElementById('qty-input');el.value=Math.max(100,(parseInt(el.value)||0)+d);updateOrderSummary();}
function chartAdjustQty(d){const el=document.getElementById('chart-qty-input');el.value=Math.max(100,(parseInt(el.value)||0)+d);}
function boardAdjustQty(d){const el=document.getElementById('board-qty-input');el.value=Math.max(100,(parseInt(el.value)||0)+d);}
function setQty(q){document.getElementById('qty-input').value=Math.max(100,Math.round(q/100)*100);updateOrderSummary();}
function setQtyMax(){const p=state.prices[state.currentSymbol];document.getElementById('qty-input').value=Math.max(100,Math.floor(state.balance/(p*1.001)/100)*100);updateOrderSummary();}
function chartSetQty(q){document.getElementById('chart-qty-input').value=Math.max(100,Math.round(q/100)*100);}
function chartSetQtyMax(){const p=state.prices[state.currentSymbol];document.getElementById('chart-qty-input').value=Math.max(100,Math.floor(state.balance/(p*1.001)/100)*100);}

function executeTrade(type){
  const qty = parseInt(document.getElementById('qty-input').value);
  if (state.orderType === 'limit') {
    const limitPrice = parseInt(document.getElementById('limit-price-input').value);
    if (!limitPrice || limitPrice <= 0) { showNotif('æŒ‡å€¤ä¾¡æ ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','error'); return; }
    if (type === 'sell') {
      const pos = state.positions[state.currentSymbol];
      const pendingSellQty = state.pendingOrders.filter(o => (o.type==='sell') && o.symbol===state.currentSymbol).reduce((s,o)=>s+o.qty,0);
      if (qty > (pos.qty - pendingSellQty)) { showNotif(`å£²ã‚Šæ³¨æ–‡è¶…é (ä¿æœ‰${pos.qty}æ ª)`, 'error'); return; }
    }
    state.pendingOrders.push({orderType:'limit', type, symbol: state.currentSymbol, qty, limitPrice});
    showNotif(`æŒ‡å€¤æ³¨æ–‡å—ä»˜ ${type==='buy'?'è²·':'å£²'}ã„ @${limitPrice.toLocaleString()}å†† Ã— ${qty}æ ª`, type==='buy'?'buy':'sell');
  } else if (state.orderType === 'stop') {
    const stopPrice = parseInt(document.getElementById('stop-price-input').value);
    if (!stopPrice || stopPrice <= 0) { showNotif('ãƒˆãƒªã‚¬ãƒ¼ä¾¡æ ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','error'); return; }
    if (type === 'sell') {
      const pos = state.positions[state.currentSymbol];
      const pendingSellQty = state.pendingOrders.filter(o => (o.type==='sell') && o.symbol===state.currentSymbol).reduce((s,o)=>s+o.qty,0);
      if (qty > (pos.qty - pendingSellQty)) { showNotif(`å£²ã‚Šæ³¨æ–‡è¶…é (ä¿æœ‰${pos.qty}æ ª)`, 'error'); return; }
    }
    state.pendingOrders.push({orderType:'stop', type, symbol: state.currentSymbol, qty, stopPrice});
    showNotif(`é€†æŒ‡å€¤æ³¨æ–‡å—ä»˜ ${type==='buy'?'è²·':'å£²'}ã„ @${stopPrice.toLocaleString()}å†† Ã— ${qty}æ ª`, type==='buy'?'buy':'sell');
  } else {
    if (type === 'sell') {
      const pos = state.positions[state.currentSymbol];
      if (qty > pos.qty) { showNotif(`å£²ã‚Šæ³¨æ–‡è¶…é (ä¿æœ‰${pos.qty}æ ª)`, 'error'); return; }
    }
    _trade(type, qty);
  }
}
function chartExecuteTrade(type){_trade(type,parseInt(document.getElementById('chart-qty-input').value));}

function _trade(type,qty,sym,fixedPrice){
  if(!qty||qty<=0){showNotif('æ•°é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','error');return;}
  const symbol=sym||state.currentSymbol;
  const price=fixedPrice||state.prices[symbol];
  const fee=0;
  const pos=state.positions[symbol];
  if(type==='buy'){
    const cost=price*qty+fee;
    if(cost>state.balance){showNotif('æ®‹é«˜ä¸è¶³ã§ã™','error');return;}
    state.balance-=cost;
    const pq=pos.qty,pa=pos.avgPrice; pos.qty+=qty;
    pos.avgPrice=(pq*pa+qty*price)/pos.qty;
    addLog('buy',qty,price,fee);
    showNotif(`è²·ã„ç´„å®š ${qty}æ ª @${Math.round(price).toLocaleString()}å††`,'buy');
  } else {
    if(!pos||pos.qty<=0){showNotif('ä¿æœ‰æ ªãŒã‚ã‚Šã¾ã›ã‚“','error');return;}
    if(qty>pos.qty){showNotif(`å£²ã‚Šæ³¨æ–‡è¶…é (ä¿æœ‰${pos.qty}æ ª)`, 'error');return;}
    const sq=qty, pnl=(price-pos.avgPrice)*sq-fee;
    state.balance+=price*sq-fee; state.realizedPnL+=pnl;
    if(pnl>0)state.wins++;else if(pnl<0)state.losses++;
    pos.qty-=sq; if(pos.qty===0)pos.avgPrice=0;
    addLog('sell',sq,price,fee,pnl);
    showNotif(`å£²ã‚Šç´„å®š ${sq}æ ª @${Math.round(price).toLocaleString()}å†† (${pnl>=0?'+':''}Â¥${Math.round(pnl).toLocaleString()})`,'sell');
  }
  updateUI();
}

function addLog(type,qty,price,fee,pnl){
  const logEl=document.getElementById('trade-log');
  const empty=logEl.querySelector('.empty-state'); if(empty) empty.remove();
  const time=new Date().toTimeString().slice(0,8);
  let pnlHtml=pnl!==undefined?`<div class="log-pnl ${pnl>=0?'pnl-pos':'pnl-neg'}">${pnl>=0?'+':''}Â¥${Math.round(pnl).toLocaleString()}</div>`:'';
  const entry=document.createElement('div');
  entry.className=`log-entry log-${type}`;
  entry.innerHTML=`<div><div class="log-type ${type==='buy'?'up':'down'}">${type==='buy'?'â–² BUY':'â–¼ SELL'} Â· ${state.currentSymbol}</div><div class="log-detail">${time} Â· ${qty.toLocaleString()}æ ª</div></div><div><div class="log-price">${Math.round(price).toLocaleString()}å††</div>${pnlHtml}</div>`;
  logEl.insertBefore(entry,logEl.firstChild);
  if(logEl.children.length>50) logEl.removeChild(logEl.lastChild);
}

function showNotif(msg,type){
  const el=document.createElement('div');
  el.className=`notification notif-${type}`; el.textContent=msg;
  document.body.appendChild(el); setTimeout(()=>el.remove(),3000);
}

function setTF(sec,btn){
  state.tf=sec;
  document.querySelectorAll('.tf-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  drawChart();
}

function togglePause(){
  state.paused=!state.paused;
  document.getElementById('pause-btn').textContent=state.paused?'â–¶ å†é–‹':'â¸ åœæ­¢';
}

function updateSpeed(v){state.speed=parseInt(v);document.getElementById('speed-label').textContent=v+'x';}

function resetGame(){
  // confirm()ã¯iOSã§å‹•ä½œã—ãªã„ãŸã‚ã‚«ã‚¹ã‚¿ãƒ ç¢ºèª
  const overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:9999;display:flex;align-items:center;justify-content:center;';
  overlay.innerHTML = `
    <div style="background:#1a1a2e;border:1px solid #333;border-radius:16px;padding:24px;width:280px;text-align:center;">
      <div style="font-family:'Share Tech Mono',monospace;font-size:15px;color:#fff;margin-bottom:8px;">RESET</div>
      <div style="font-size:12px;color:#888;margin-bottom:20px;">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ</div>
      <div style="display:flex;gap:10px;">
        <div id="reset-cancel" style="flex:1;padding:10px;border:1px solid #444;border-radius:10px;color:#888;font-family:'Share Tech Mono',monospace;font-size:13px;cursor:pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</div>
        <div id="reset-ok" style="flex:1;padding:10px;border:1px solid #ff9500;border-radius:10px;color:#ff9500;font-family:'Share Tech Mono',monospace;font-size:13px;cursor:pointer;">ãƒªã‚»ãƒƒãƒˆ</div>
      </div>
    </div>`;
  document.body.appendChild(overlay);
  document.getElementById('reset-cancel').onclick = () => overlay.remove();
  document.getElementById('reset-ok').onclick = () => {
    overlay.remove();
    state.balance=10_000_000; state.realizedPnL=0; state.wins=0; state.losses=0;
    state.pendingOrders=[];
    STOCKS.forEach(s=>{
      state.positions[s.symbol]={qty:0,avgPrice:0};
      state.prices[s.symbol]=s.basePrice;
      state.history[s.symbol]=genHistory(s.basePrice,s.vol);
      state.trends[s.symbol]=0;
    });
    document.getElementById('trade-log').innerHTML='<div class="empty-state"><div class="icon">ğŸ“‹</div><div>ã¾ã å–å¼•å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div></div>';
    renderPendingOrders();
    updateUI(); drawChart();
  };
}

// TAB SWITCHING
function switchTab(name, tabEl) {
  document.querySelectorAll('.scroll-container').forEach(el=>el.classList.remove('active'));
  document.getElementById('chart-container').classList.remove('active');
  document.querySelectorAll('.tab-item').forEach(t=>t.classList.remove('active'));
  if (name==='chart') {
    document.getElementById('chart-container').classList.add('active');
    setTimeout(drawChart, 50);
  } else {
    document.getElementById('scroll-'+name).classList.add('active');
    document.getElementById('scroll-'+name).scrollTop=0;
    if (name==='board') renderBoard();
  }
  tabEl.classList.add('active');
}

[{id:'tab-home',name:'home'},{id:'tab-chart',name:'chart'},{id:'tab-board',name:'board'},{id:'tab-trade',name:'trade'},{id:'tab-log',name:'log'}]
.forEach(({id,name})=>{
  const el=document.getElementById(id);
  el.addEventListener('touchstart',function(e){e.preventDefault();switchTab(name,el);},{passive:false});
  el.addEventListener('click',()=>switchTab(name,el));
});

// GAME LOOP
let lastTick=0;
function gameLoop(ts){
  if(!state.paused){
    const interval=Math.max(50,500/state.speed);
    if(ts-lastTick>interval){
      lastTick=ts; updatePrices(); updateUI();
      if (document.getElementById('scroll-board').classList.contains('active')) renderBoard();
      if(document.getElementById('chart-container').classList.contains('active')) drawChart();
    }
  }
  requestAnimationFrame(gameLoop);
}

updateUI(); drawChart(); requestAnimationFrame(gameLoop);
window.addEventListener('resize', drawChart);

// ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
</script>
</body>
</html>
